<html>
	<head>
	  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
	  <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
	  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
<link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet">
		<style>
			.user{
				margin-left: auto;
				margin-right: 0
			}
		</style>
	</head>
	<body>
		<div id="app">
			<v-app toolbar>
				<v-toolbar fixed>
					<v-btn flat icon color="green" @click="newUser = true">
					  <v-icon>add</v-icon>
					</v-btn>
					<v-toolbar-title style="margin-right: 1rem">User</v-toolbar-title>
					<v-select
					  v-model="select"
					  :hint="`${select.id}`"
					  :items="users"
					  item-text="username"
					  item-value="id"
					  label="Select"
					  persistent-hint
					  return-object
					  single-line
					></v-select>
					<v-btn flat icon color="green" @click="updateUsers">
					  <v-icon>cached</v-icon>
					</v-btn>
				</v-toolbar>
				<main>
					<v-container id="lc">
						<div ref="messageList" style="margin-top: 3rem">
							<v-layout row v-for="message in messages" style="margin-top: 3rem" v-bind:class="{bot: message.bot}">
									<v-card :color="message.bot?'purple':'green'" class="white--text" v-bind:class="{user: !message.bot}" >
									  <v-layout row>
										<v-flex xs10>
										  <v-card-title primary-title>
											<div>
											  <div class="headline">{{ message.text }}</div>
											</div>
										  </v-card-title>
										</v-flex>
										<v-flex xs2 style="text-align: right">
											<v-card-text >
												{{ message.bot?'Bot':'User' }}
											</v-card-text>
										</v-flex>
									  </v-layout>
									  <v-divider light></v-divider>
									  <v-card-actions class="pa-3">
										{{ message.id }}
										<v-spacer></v-spacer>
										{{ message.timestamp }}
									  </v-card-actions>
									</v-card>
							</v-layout>
						</div>
					</v-container>

					  <v-layout row justify-center>
						<v-dialog v-model="waiting" persistent max-width="290">
						  <v-card>
							<v-card-title class="headline">Please wait</v-card-title>
							<v-card-text>Wait until the request is complete</v-card-text>
							<v-progress-linear :indeterminate="true"></v-progress-linear>
						  </v-card>
						</v-dialog>
					  </v-layout>

					  <v-layout row justify-center>
						<v-dialog v-model="newUser" persistent max-width="600">
						  <v-card>
							<v-card-title class="headline">Create new user</v-card-title>
							<v-form @submit.prevent="createUser">
								<v-text-field
									v-model="newUsername"
									box
									label="Username"
									clearable
								></v-text-field>
							</v-form>
							<v-card-actions>
								<v-btn flat icon color="red" @click="newUser = false">
								  <v-icon>cancel</v-icon>
								</v-btn>
								<v-spacer>
								</v-spacer>
								<v-btn flat icon color="green" @click="createUser">
								  <v-icon>add</v-icon>
								</v-btn>
							</v-card-actions>
						  </v-card>
						</v-dialog>
					  </v-layout>


					<v-form @submit.prevent="sendMessage">
						<v-container>
							<v-layout row wrap>
								<v-flex xs12>
									<v-text-field
										v-model="msg"
										append-outer-icon="send"
										box
										label="Message"
										clearable
										@click:append-outer="sendMessage"
									></v-text-field>
								</v-flex>
							</v-layout>
						</v-container>
					</v-form>
				</main>
			</v-app>
		</div>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
		<script>
			const baseUrl = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');

			function updateMessages(userId, after) {
				url = baseUrl + '/api/message/user/' + userId
				if (after != undefined) {
					url+='?after='+encodeURIComponent(after)
				}

				return fetch(url).then(x => x.json()).then(x => {
					if (after != undefined) {
						app.messages = app.messages.concat(x.reverse())
					} else {
						app.messages = x.reverse()
					}
				}).catch(w => alert('Errore:' + w))
			}

			function updateUsers(){
				return fetch(baseUrl + '/api/user').then(x => x.json()).then(x => {
					app.users = x
				}).catch(w => alert('Errore:' + w))
			}

			function sendMessage(e){
				e.preventDefault()

				this.waiting = true
				return fetch(baseUrl + '/api/message/' + this.select.id +'/000000000000000000000001', {
					method: 'PUT',
					headers: {
					  'Accept': 'application/json',
					  'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						'text': this.msg
					})
				}).then(
					x => x.json()
				).then(
					x => updateMessages(this.select.id, this.messages[this.messages.length-1].timestamp)
				).then(
					w => {this.waiting = false; this.msg = '';}
				).catch(e => alert(e))
			}

			function createUser(e){
				e.preventDefault()

				this.waiting = true
				fetch(baseUrl + '/api/user', {
					method: 'PUT',
					headers: {
					  'Accept': 'application/json',
					  'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						'username': this.newUsername
					})
				}).then(
					user => user.json()
				).then(
					user => updateUsers().then(y => Promise.resolve(user))
				).then(
					user => updateMessages(user.id)
				).then(
					w => {this.waiting = false; this.newUser=false}
				).catch(e => alert(e))
			}


			const app = new Vue({
				el: "#app",
				data(){
					return {
						users: [],
						messages: [],
						select: {},
						msg: "",
						waiting: false,
						newUser: false,
						newUsername: ""
					}
				},
				watch: {
					select(val) {
						updateMessages(val.id)
					}
				},
				methods: {
					updateUsers,
					sendMessage,
					createUser
				}
			})

			updateUsers()
		</script>
	</body>
</html>
